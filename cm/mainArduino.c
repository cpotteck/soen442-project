

#include "hal.h"
#include "out.h"
#include "vm.h"
#include "command_types.h"
#define F_CPU 16000000UL
#include <avr/io.h>

#define MemMax 300

#if TestTargetPrecompiled

void main(void) {
    Hal_Init();

    // Test pre-compiled T11.exe
    u8 T11[] = { 0xE1, 0x00, 0x25, 0x71, 0xD5, 0x00, 0x2F, 0xFF, 0x85, 0xD5, 0x00, 0x44, 0xFF, 0x85,
    0xD9, 0x09, 0xA8, 0xE0, 0x0E, 0xA0, 0x90, 0x1C, 0xE3, 0x04, 0xE0, 0x09, 0xA0, 0xB4, 0x00, 0xFF,
    0x82, 0xE0, 0xF4, 0xFF, 0x87, 0x03, 0x04, 0xE7, 0xFF, 0xFF, 0xE7, 0xFF, 0xDB, 0x00, 0x54, 0x2E,
    0x53, 0x74, 0x6D, 0x74, 0x00, 0x54, 0x65, 0x73, 0x74, 0x20, 0x31, 0x31, 0x3A, 0x20, 0x62, 0x72,
    0x65, 0x61, 0x6B, 0x20, 0x53, 0x74, 0x61, 0x74, 0x65, 0x6D, 0x65, 0x6E, 0x74, 0x0A, 0x00, 0x39,
    0x38, 0x37, 0x36, 0x35, 0x34, 0x33, 0x32, 0x31, 0x30, 0x0A, 0x00 };
    VM_Init(T11);
    VM_execute(T11);

    
    // Test pre-compiled T01.exe
    u8 T01[] = { 0xE1, 0x00, 0x99, 0xD5, 0x00, 0xA1, 0xFF, 0x85, 0xD5, 0x00, 0xBD, 0xFF, 0x85, 0xD9, 
    0x80, 0xFF, 0x82, 0xD9, 0x7C, 0xFF, 0x81, 0xD9, 0x7F, 0xFF, 0x82, 0xD9, 0x7C, 0xFF, 0x81, 0xD9, 
    0x7F, 0xFF, 0x82, 0xD9, 0x7C, 0xFF, 0x81, 0xD9, 0x7F, 0xFF, 0x83, 0xD9, 0x7C, 0xFF, 0x81, 0xDB, 
    0x00, 0x0D, 0xEC, 0xAF, 0xFF, 0x86, 0xD9, 0x7C, 0xFF, 0x81, 0xDB, 0x00, 0x00, 0xAB, 0x8D, 0xFF, 
    0x86, 0xD9, 0x7C, 0xFF, 0x81, 0xD9, 0x30, 0xFF, 0x81, 0xD9, 0x7C, 0xFF, 0x81, 0xD9, 0x39, 0xFF, 
    0x81, 0xD9, 0x7C, 0xFF, 0x81, 0xD9, 0x61, 0xFF, 0x81, 0xD9, 0x7C, 0xFF, 0x81, 0xD9, 0x41, 0xFF, 
    0x81, 0xD9, 0x7C, 0xFF, 0x81, 0xD9, 0x0A, 0xFF, 0x82, 0xD9, 0x7C, 0xFF, 0x81, 0xD9, 0x0A, 0xFF, 
    0x82, 0xD9, 0x7C, 0xFF, 0x81, 0xD9, 0x0A, 0xFF, 0x82, 0xD9, 0x7C, 0xFF, 0x81, 0xD9, 0x0A, 0xFF, 
    0x82, 0xD9, 0x7C, 0xFF, 0x81, 0xD9, 0x0A, 0xFF, 0x82, 0xD9, 0x7C, 0xFF, 0x81, 0x90, 0xFF, 0x80, 
    0xD9, 0x7C, 0xFF, 0x81, 0x91, 0xFF, 0x80, 0xFF, 0x87, 0x04, 0x04, 0xE7, 0xFF, 0xFF, 0xE7, 0xFF, 
    0x67, 0x00, 0x54, 0x2E, 0x43, 0x00, 0x54, 0x65, 0x73, 0x74, 0x20, 0x30, 0x31, 0x3A, 0x20, 0x56, 
    0x61, 0x6C, 0x75, 0x65, 0x20, 0x54, 0x79, 0x70, 0x65, 0x73, 0x20, 0x28, 0x4C, 0x69, 0x74, 0x65, 
    0x72, 0x61, 0x6C, 0x73, 0x29, 0x0A, 0x00, 0x2D, 0x31, 0x32, 0x38, 0x7C, 0x31, 0x32, 0x37, 0x7C, 
    0x31, 0x32, 0x37, 0x7C, 0x31, 0x32, 0x37, 0x7C, 0x30, 0x30, 0x30, 0x44, 0x45, 0x43, 0x41, 0x46,
    0x7C, 0x30, 0x30, 0x30, 0x30, 0x41, 0x42, 0x38, 0x44, 0x7C, 0x30, 0x7C, 0x39, 0x7C, 0x61, 0x7C, 
    0x41, 0x7C, 0x31, 0x30, 0x7C, 0x31, 0x30, 0x7C, 0x31, 0x30, 0x7C, 0x31, 0x30, 0x7C, 0x31, 0x30, 
    0x7C, 0x66, 0x61, 0x6C, 0x73, 0x65, 0x7C, 0x74, 0x72, 0x75, 0x65, 0x0A, 0x00 };
    VM_Init(T01);
    VM_execute(T01);
}

#else

unsigned int UBRR0_value = 103;
bool toggle = false;

char UART_receive() {
  char readChar;

  // Wait until unread data received
  while ( !(UCSR0A & (1 << RXC0)) ) {
    PORTB |= 1 << 5;
  };

  PORTB ^= (1 << 5);
  // Read data
  readChar = (char)UDR0;

  return readChar;
}

void UART_transmit(char data) {
  while ( !(UCSR0A & (1 << UDRE0)) );
  UDR0 = data;
}




int main(void) {
  
  // Set PIN 13 (PB5) as output to control LED
  DDRB = 1 << 5;

  // Set BAUD rate
  UBRR0H = UBRR0_value >> 8; 
  UBRR0L = UBRR0_value;

  // Enable receiver and transmitter
  UCSR0B |= (1 << RXEN0) | (1 << TXCIE0);
  
  /*  Using default frame format:
   *  Async
   *  No parity
   *  8-bit character size
   *  1-bit stop bit
  */
  
  while(1) {
    Hal_Init();
    u8 program[MemMax]  = {};
    int count = 0;

    u8 programSize[2] = { };
    int sizeCount = 0;
    int size = 0;

    bool run = true;

    while(1) {
      char readChar = UART_receive();
      
      // Calculate program size using first 2 bytes
      if (sizeCount <= 1) {
        programSize[sizeCount++] = (u8)readChar;
        if (sizeCount == 2) {
          size = programSize[0] << 8 | programSize[1];
        }
      }
      // Load program
      else {
        // Ignore program if too large
        if (size > MemMax ) {
          count++;
          while (count < size) {
            count++;
            char garbo = UART_receive();
          }
          
          run = false;
          VMOut_PutS("Program is too big (max ");
          VMOut_PutI(MemMax);
          VMOut_PutS(" bytes)\n");
          break;
        }
        else {
          *(program + count) = readChar;
          count++;

          if (count == size) {
            break;
          }
        }
      }
    }

    if (run == true) {
      // Run program
      VM_Init(program);
      VM_execute(program);
    }
  }
}
#endif
